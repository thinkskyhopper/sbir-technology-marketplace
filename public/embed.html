
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBIR Tech Marketplace Widget</title>
    <style>
        /* Embedded styles matching the main site */
        .sbir-widget {
            --background: 220 20% 14%;
            --foreground: 220 20% 94%;
            --card: 220 20% 16%;
            --card-foreground: 220 20% 94%;
            --primary: 217 91% 65%;
            --primary-foreground: 220 20% 10%;
            --secondary: 220 20% 20%;
            --secondary-foreground: 220 20% 94%;
            --muted: 220 20% 22%;
            --muted-foreground: 220 20% 75%;
            --accent: 220 20% 24%;
            --accent-foreground: 220 20% 94%;
            --border: 220 20% 26%;
            --input: 220 20% 26%;
            --ring: 217 91% 65%;
            --radius: 0.375rem;
            
            max-width: 24rem;
            margin: 0 auto;
            background-color: hsl(var(--background));
            border: 1px solid hsl(var(--border));
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: system-ui, -apple-system, sans-serif;
            color: hsl(var(--foreground));
        }
        
        .sbir-widget .logo-section {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .sbir-widget .logo {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 0.5rem;
            background-color: hsl(var(--primary));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .sbir-widget .title {
            font-size: 1.125rem;
            font-weight: bold;
            margin: 0;
        }
        
        .sbir-widget .text-gradient {
            background: linear-gradient(135deg, hsl(var(--primary)), hsl(217 91% 80%));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sbir-widget .buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .sbir-widget .btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .sbir-widget .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .sbir-widget .btn-primary:hover {
            background-color: hsl(var(--primary) / 0.9);
        }
        
        .sbir-widget .btn-outline {
            background-color: transparent;
            color: hsl(var(--foreground));
            border: 1px solid hsl(var(--border));
        }
        
        .sbir-widget .btn-outline:hover {
            background-color: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }
        
        .sbir-widget .listings {
            margin-bottom: 1rem;
        }
        
        .sbir-widget .listing-card {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .sbir-widget .listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .sbir-widget .badge {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        
        .sbir-widget .badge-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        
        .sbir-widget .badge-active {
            background-color: hsl(120 60% 50%);
            color: white;
        }
        
        .sbir-widget .listing-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0.25rem 0;
            color: hsl(var(--card-foreground));
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
        }
        
        .sbir-widget .listing-agency {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 0.5rem;
        }
        
        .sbir-widget .listing-description {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            margin-bottom: 0.5rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .sbir-widget .listing-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }
        
        .sbir-widget .listing-value {
            font-weight: 600;
            color: hsl(120 60% 50%);
        }
        
        .sbir-widget .view-all {
            text-align: center;
        }
        
        .sbir-widget .view-all-link {
            color: hsl(var(--primary));
            text-decoration: underline;
            font-size: 0.875rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .sbir-widget .view-all-link:hover {
            color: hsl(var(--primary) / 0.8);
        }
        
        .sbir-widget .loading {
            text-align: center;
            padding: 2rem 0;
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
        }
        
        .sbir-widget .error {
            text-align: center;
            padding: 2rem 0;
            color: hsl(0 60% 60%);
            font-size: 0.875rem;
        }
        
        .sbir-widget .debug {
            background-color: hsl(var(--muted));
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-family: monospace;
            color: hsl(var(--muted-foreground));
            white-space: pre-wrap;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .sbir-widget {
                max-width: 100%;
                padding: 0.75rem;
            }
            
            .sbir-widget .title {
                font-size: 1rem;
            }
            
            .sbir-widget .btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.8125rem;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .sbir-widget {
                --background: 220 25% 8%;
                --foreground: 220 25% 98%;
                --card: 220 25% 10%;
                --card-foreground: 220 25% 98%;
                --muted: 220 25% 15%;
                --muted-foreground: 220 25% 90%;
                --border: 220 25% 35%;
                --primary: 217 91% 70%;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .sbir-widget * {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div id="sbir-widget-root">
        <div class="sbir-widget">
            <div class="loading">Initializing widget...</div>
            <div class="debug">Widget starting up...</div>
        </div>
    </div>
    
    <script>
        // Immediate debug output
        console.log('üöÄ SBIR Widget HTML loaded successfully');
        console.log('üìç Current URL:', window.location.href);
        console.log('üåê User Agent:', navigator.userAgent);
        
        // Add visual debug output
        function addDebugMessage(message) {
            const debugElement = document.querySelector('.debug');
            if (debugElement) {
                debugElement.textContent += '\n' + message;
            }
            console.log(message);
        }
        
        addDebugMessage('Script execution started');
        
        // Check if we can access the container
        const container = document.getElementById('sbir-widget-root');
        if (container) {
            addDebugMessage('‚úÖ Container found');
        } else {
            addDebugMessage('‚ùå Container not found');
        }
        
        // Load Supabase dynamically with error handling
        function loadSupabase() {
            return new Promise((resolve, reject) => {
                addDebugMessage('Loading Supabase library...');
                
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@supabase/supabase-js@2';
                script.onload = () => {
                    addDebugMessage('‚úÖ Supabase library loaded');
                    if (window.supabase) {
                        resolve(window.supabase);
                    } else {
                        reject(new Error('Supabase not available after loading'));
                    }
                };
                script.onerror = () => {
                    addDebugMessage('‚ùå Failed to load Supabase library');
                    reject(new Error('Failed to load Supabase'));
                };
                document.head.appendChild(script);
            });
        }
        
        // SBIR Widget implementation
        class SBIRWidget {
            constructor(containerId) {
                addDebugMessage('üèóÔ∏è Constructing SBIRWidget');
                this.container = document.getElementById(containerId);
                
                if (!this.container) {
                    addDebugMessage('‚ùå Container element not found: ' + containerId);
                    return;
                }
                
                this.listings = [];
                this.loading = true;
                this.error = null;
                this.debugMessages = ['Widget initialized'];
                
                this.init();
            }
            
            async init() {
                try {
                    addDebugMessage('üîÑ Initializing widget...');
                    this.render();
                    
                    // Load Supabase
                    const supabase = await loadSupabase();
                    this.supabase = supabase.createClient(
                        'https://amhznlnhrrugxatbeayo.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtaHpubG5ocnJ1Z3hhdGJlYXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMDA2NDUsImV4cCI6MjA2NTY3NjY0NX0.36_2NRiObrLxWx_ngeNzMvOSzxcFpeGXh-xKoW4irkk'
                    );
                    addDebugMessage('‚úÖ Supabase client created');
                    
                    await this.fetchListings();
                    this.render();
                } catch (error) {
                    addDebugMessage('‚ùå Widget initialization failed: ' + error.message);
                    this.error = 'Widget initialization failed: ' + error.message;
                    this.loading = false;
                    this.render();
                }
            }
            
            async fetchListings() {
                try {
                    addDebugMessage('üîÑ Fetching listings...');
                    
                    // Get featured listings first
                    const { data: featuredData, error: featuredError } = await this.supabase
                        .from('featured_listings')
                        .select(`
                            *,
                            sbir_listings!inner(
                                *,
                                profiles!fk_sbir_listings_user_id(
                                    full_name,
                                    email
                                )
                            )
                        `)
                        .eq('sbir_listings.status', 'Active')
                        .order('display_order', { ascending: true })
                        .limit(3);

                    if (featuredError) {
                        addDebugMessage('‚ö†Ô∏è Featured listings error: ' + featuredError.message);
                        throw featuredError;
                    }

                    addDebugMessage('üìä Featured listings received: ' + (featuredData?.length || 0));

                    let listings = [];

                    // Extract the listing data and format it
                    if (featuredData && featuredData.length > 0) {
                        listings = featuredData.map(item => ({
                            ...item.sbir_listings,
                            value: item.sbir_listings.value / 100,
                            deadline: new Date(item.sbir_listings.deadline).toISOString().split('T')[0],
                        }));
                        addDebugMessage('‚úÖ Featured listings processed: ' + listings.length);
                    }

                    // If we need more listings, fetch newest
                    if (listings.length < 3) {
                        const neededCount = 3 - listings.length;
                        const featuredIds = listings.map(listing => listing.id);
                        
                        addDebugMessage('üîÑ Fetching newest listings: ' + neededCount);

                        let query = this.supabase
                            .from('sbir_listings')
                            .select(`
                                *,
                                profiles!fk_sbir_listings_user_id(
                                    full_name,
                                    email
                                )
                            `)
                            .eq('status', 'Active')
                            .order('submitted_at', { ascending: false })
                            .limit(neededCount);

                        if (featuredIds.length > 0) {
                            query = query.not('id', 'in', `(${featuredIds.join(',')})`);
                        }

                        const { data: newestData, error: newestError } = await query;

                        if (newestError) {
                            addDebugMessage('‚ö†Ô∏è Newest listings error: ' + newestError.message);
                            throw newestError;
                        }

                        addDebugMessage('üìä Newest listings received: ' + (newestData?.length || 0));

                        const newestListings = newestData?.map(listing => ({
                            ...listing,
                            value: listing.value / 100,
                            deadline: new Date(listing.deadline).toISOString().split('T')[0],
                        })) || [];

                        listings = [...listings, ...newestListings];
                    }

                    this.listings = listings.slice(0, 3);
                    this.loading = false;
                    addDebugMessage('‚úÖ Final listings count: ' + this.listings.length);
                    
                } catch (error) {
                    addDebugMessage('‚ùå Fetch error: ' + error.message);
                    this.error = 'Failed to load opportunities: ' + error.message;
                    this.loading = false;
                }
            }
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(amount);
            }
            
            formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            render() {
                let listingsHTML = '';
                
                if (this.loading) {
                    listingsHTML = '<div class="loading">Loading opportunities...</div>';
                } else if (this.error) {
                    listingsHTML = `<div class="error">${this.error}</div>`;
                } else if (this.listings.length === 0) {
                    listingsHTML = '<div class="loading">No opportunities available</div>';
                } else {
                    listingsHTML = this.listings.map(listing => `
                        <div class="listing-card">
                            <div class="listing-header">
                                <span class="badge badge-primary">${listing.phase}</span>
                                <span class="badge ${listing.status === 'Active' ? 'badge-active' : ''}">${listing.status}</span>
                            </div>
                            <h3 class="listing-title">${listing.title}</h3>
                            <div class="listing-agency">üè¢ ${listing.agency}</div>
                            <p class="listing-description">${listing.description}</p>
                            <div class="listing-meta">
                                <div>
                                    <span class="listing-value">$${this.formatCurrency(listing.value)}</span>
                                    <span class="badge" style="margin-left: 0.5rem; background: hsl(var(--muted)); color: hsl(var(--muted-foreground));">${listing.category}</span>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <small style="color: hsl(var(--muted-foreground));">üìÖ ${this.formatDate(listing.deadline)}</small>
                                <button class="btn btn-outline" style="flex: none; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="window.open('https://sbirtech.lovableproject.com/listing/${listing.id}', '_blank')">
                                    üìÑ View Details
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                if (!this.container) {
                    addDebugMessage('‚ùå Container lost during render');
                    return;
                }
                
                this.container.innerHTML = `
                    <div class="sbir-widget">
                        <div class="logo-section">
                            <div class="logo">ST</div>
                            <h2 class="title">
                                <span class="text-gradient">The SBIR Tech </span>
                                <span>Marketplace</span>
                            </h2>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-primary" onclick="window.open('https://sbirtech.lovableproject.com/', '_blank')">
                                Explore
                            </button>
                            <button class="btn btn-outline" onclick="window.open('https://sbirtech.lovableproject.com/', '_blank')">
                                Learn More
                            </button>
                        </div>
                        
                        <div class="listings">
                            ${listingsHTML}
                        </div>
                        
                        <div class="view-all">
                            <a href="#" class="view-all-link" onclick="window.open('https://sbirtech.lovableproject.com/?view=marketplace', '_blank')">
                                View All Opportunities ‚Üí
                            </a>
                        </div>
                        
                        <div class="debug">${this.debugMessages.join('\n')}</div>
                    </div>
                `;
                
                addDebugMessage('üé® Widget rendered');
            }
        }
        
        // Initialize widget when DOM is ready
        function initializeWidget() {
            addDebugMessage('üöÄ Starting widget initialization...');
            try {
                new SBIRWidget('sbir-widget-root');
            } catch (error) {
                addDebugMessage('‚ùå Widget creation failed: ' + error.message);
            }
        }
        
        if (document.readyState === 'loading') {
            addDebugMessage('‚è≥ Waiting for DOM...');
            document.addEventListener('DOMContentLoaded', initializeWidget);
        } else {
            addDebugMessage('‚úÖ DOM ready, initializing...');
            initializeWidget();
        }
    </script>
</body>
</html>
